---
permalink: /python/v3/ipython-notebooks/ukelectionbbg/
description: Create interactive graphs with market data, IPython Notebook and Plotly
thumbnail: /images/static-image
layout: base
name: Plot MP Action in GBP/USD around UK General Elections
language: python/v3
page_type: u-guide
redirect_from: /ipython-notebooks/ukelectionbbg/
---
{% raw %}
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Author: Saeed Amen (@thalesians) - Managing Director &amp; Co-founder of <a href="http://www.thalesians.com">the Thalesians</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">Introduction<a class="anchor-link" href="#Introduction">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With the UK general election in early May 2015, we thought it would be a fun exercise to demonstrate how you can investigate market price action over historial elections. We shall be using Python, together with Plotly for plotting. Plotly is a free web-based platform for making graphs. You can keep graphs private, make them public, and run Plotly on your <a href="https://plot.ly/product/enterprise/">Chart Studio Enterprise on your own servers</a>. You can find more details <a href="https://plot.ly/python/getting-started/">here</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Getting-market-data-with-Bloomberg">Getting market data with Bloomberg<a class="anchor-link" href="#Getting-market-data-with-Bloomberg">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To get market data, we shall be using Bloomberg. As a starting point, we have used bbg_py from <a href="https://github.com/bpsmith/tia/tree/master/tia/bbg">Brian Smith's TIA project</a>, which allows you to access Bloomberg via COM (older method), modifying it to make it compatible for Python 3.4. Whilst, we shall note use it to access historical daily data, there are functions which enable us to download intraday data. This method is only compatible with 32 bit versions of Python and assumes you are running the code on a Bloomberg terminal (it won't work without a valid Bloomberg licence).</p>
<p>In my opinion a better way to access Bloomberg via Python, is via the official Bloomberg open source Python Open Source Graphing Library, however, at time of writing the official version is not yet compatible with Python 3.4. Fil Mackay has created a Python 3.4 compatible version of this <a href="https://github.com/filmackay/blpapi-py">here</a>, which I have used successfully. Whilst it takes slightly more time to configure (and compile using Windows SDK 7.1), it has the benefit of being compatible with 64 bit Python, which I have found invaluable in my analysis (have a read of <a href="http://ta.speot.is/2012/04/09/visual-studio-2010-sp1-windows-sdk-7-1-install-order/">this</a> in case of failed installations of Windows SDK 7.1).</p>
<p>Quandl can be used as an alternative data source, if you don't have access to a Bloomberg terminal, which I have also included in the code.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Breaking-down-the-steps-in-Python">Breaking down the steps in Python<a class="anchor-link" href="#Breaking-down-the-steps-in-Python">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our project will consist of several parts:</p>
<ul>
<li>bbg_com - low level interaction with BBG COM object (adapted for Python 3.4) (which we are simply calling)</li>
<li>datadownloader - wrapper for BBG COM, Quandl and CSV access to data</li>
<li>eventplot - reusuable functions for interacting with Plotly and creating event studies</li>
<li>ukelection - kicks off the whole script process</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Downloading-the-market-data">Downloading the market data<a class="anchor-link" href="#Downloading-the-market-data">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As with any sort of financial market analysis, the first step is obtaining market data. We create the DataDownloader class, which acts a wrapper for Bloomberg, Quandl and CSV market data. We write a single function "download_time_series" for this. We could of course extend this for other data sources such as Yahoo Finance. Our output will be Pandas based dataframes. We want to make this code generic, so the tickers are not hard coded.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># for time series manipulation</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="k">class</span> <span class="nc">DataDownloader</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">download_time_series</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vendor_ticker</span><span class="p">,</span> <span class="n">pretty_ticker</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">csv_file</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;Quandl&#39;</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">Quandl</span>
            <span class="c1"># Quandl requires API key for large number of daily downloads</span>
            <span class="c1"># https://www.quandl.com/help/api</span>
            <span class="n">spot</span> <span class="o">=</span> <span class="n">Quandl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vendor_ticker</span><span class="p">)</span>    <span class="c1"># Bank of England&#39;s database on Quandl</span>
            <span class="n">spot</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">spot</span><span class="p">[</span><span class="s1">&#39;Value&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">spot</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">spot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">pretty_ticker</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;Bloomberg&#39;</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">bbg_com</span> <span class="kn">import</span> <span class="n">HistoricalDataRequest</span>
            <span class="n">req</span> <span class="o">=</span> <span class="n">HistoricalDataRequest</span><span class="p">([</span><span class="n">vendor_ticker</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;PX_LAST&#39;</span><span class="p">],</span> <span class="n">start</span> <span class="o">=</span> <span class="n">start_date</span><span class="p">)</span>
            <span class="n">req</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

            <span class="n">spot</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">response_as_single</span><span class="p">()</span>
            <span class="n">spot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">pretty_ticker</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;CSV&#39;</span><span class="p">:</span>
            <span class="n">dateparse</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pandas</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># in case you want to use a source other than Bloomberg/Quandl</span>
            <span class="n">spot</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">date_parser</span><span class="o">=</span><span class="n">dateparse</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spot</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Generic-functions-for-event-study-and-Plotly-plotting">Generic functions for event study and Plotly plotting<a class="anchor-link" href="#Generic-functions-for-event-study-and-Plotly-plotting">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We now focus our efforts on the EventPlot class. Here we shall do our basic analysis. We shall aslo create functions for creating plotly traces and layouts that we shall reuse a number of times. The analysis we shall conduct is fairly simple. Given a time series of spot, and a number of dates, we shall create an event study around these times for that asset. We also include the "Mean" move over all the various dates.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># for dates</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># time series manipulation</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># for plotting data</span>
<span class="kn">import</span> <span class="nn">plotly</span>
<span class="kn">from</span> <span class="nn">plotly.graph_objs</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">EventPlot</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">event_study</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot</span><span class="p">,</span> <span class="n">dates</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">mean_label</span> <span class="o">=</span> <span class="s1">&#39;Mean&#39;</span><span class="p">):</span>
        <span class="c1"># event_study - calculates the asset price moves over windows around event days</span>
        <span class="c1">#</span>
        <span class="c1"># spot = price of asset to study</span>
        <span class="c1"># dates = event days to anchor our event study</span>
        <span class="c1"># pre = days before the event day to start our study</span>
        <span class="c1"># post = days after the event day to start our study</span>
        <span class="c1">#</span>

        <span class="n">data_frame</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="c1"># for each date grab spot data the days before and after</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dates</span><span class="p">)):</span>
            <span class="n">mid_index</span> <span class="o">=</span> <span class="n">spot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">start_index</span> <span class="o">=</span> <span class="n">mid_index</span> <span class="o">+</span> <span class="n">pre</span>
            <span class="n">finish_index</span> <span class="o">=</span> <span class="n">mid_index</span> <span class="o">+</span> <span class="n">post</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">spot</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">start_index</span><span class="p">:</span><span class="n">finish_index</span><span class="p">])[</span><span class="n">spot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">data_frame</span><span class="p">[</span><span class="n">dates</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">values</span>

        <span class="n">data_frame</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">data_frame</span> <span class="o">=</span> <span class="n">data_frame</span> <span class="o">/</span> <span class="n">data_frame</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>   <span class="c1"># returns</span>

        <span class="c1"># add the mean on to the end</span>
        <span class="n">data_frame</span><span class="p">[</span><span class="n">mean_label</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_frame</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">data_frame</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">data_frame</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>   <span class="c1"># index</span>
        <span class="n">data_frame</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">pre</span><span class="p">,:]</span> <span class="o">=</span> <span class="mi">100</span>

        <span class="k">return</span> <span class="n">data_frame</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We write a function to convert dates represented in a string format to Python format.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="k">def</span> <span class="nf">parse_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">str_dates</span><span class="p">):</span>
        <span class="c1"># parse_dates - parses string dates into Python format</span>
        <span class="c1">#</span>
        <span class="c1"># str_dates = dates to be parsed in the format of day/month/year</span>
        <span class="c1">#</span>

        <span class="n">dates</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">str_dates</span><span class="p">:</span>
            <span class="n">dates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1">/%m/%Y&#39;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">dates</span>

    <span class="n">EventPlot</span><span class="o">.</span><span class="n">parse_dates</span> <span class="o">=</span> <span class="n">parse_dates</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our next focus is on the Plotly functions which create a layout. This enables us to specify axes labels, the width and height of the final plot and so on. We could of course add further properties into it.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="k">def</span> <span class="nf">create_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># create_layout - populates a layout object</span>
        <span class="c1"># title = title of the plot</span>
        <span class="c1"># xaxis = xaxis label</span>
        <span class="c1"># yaxis = yaxis label</span>
        <span class="c1"># width (optional) = width of plot</span>
        <span class="c1"># height (optional) = height of plot</span>
        <span class="c1">#</span>

        <span class="n">layout</span> <span class="o">=</span> <span class="n">Layout</span><span class="p">(</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">,</span>
                    <span class="n">xaxis</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">XAxis</span><span class="p">(</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">xaxis</span><span class="p">,</span>
                        <span class="n">showgrid</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="p">),</span>
                    <span class="n">yaxis</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">YAxis</span><span class="p">(</span>
                        <span class="n">title</span><span class="o">=</span> <span class="n">yaxis</span><span class="p">,</span>
                        <span class="n">showline</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">layout</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">width</span>
            <span class="n">layout</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">height</span>

        <span class="k">return</span> <span class="n">layout</span>

    <span class="n">EventPlot</span><span class="o">.</span><span class="n">create_layout</span> <span class="o">=</span> <span class="n">create_layout</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Earlier, in the DataDownloader class, our output was Pandas based dataframes. Our convert_df_plotly function will convert these each series from Pandas dataframe into plotly traces. Along the way, we shall add various properties such as markers with varying levels of opacity, graduated coloring of lines (which uses colorlover) and so on.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="k">def</span> <span class="nf">convert_df_plotly</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">axis_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color_def</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;default&#39;</span><span class="p">],</span>
                          <span class="n">special_line</span> <span class="o">=</span> <span class="s1">&#39;Mean&#39;</span><span class="p">,</span> <span class="n">showlegend</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span> <span class="n">addmarker</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="n">gradcolor</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="c1"># convert_df_plotly - converts a Pandas data frame to Plotly format for line plots</span>
        <span class="c1"># dataframe = data frame due to be converted</span>
        <span class="c1"># axis_no = axis for plot to be drawn (default = 1)</span>
        <span class="c1"># special_line = make lines named this extra thick</span>
        <span class="c1"># color_def = color scheme to be used (default = [&#39;default&#39;]), colour will alternate in the list</span>
        <span class="c1"># showlegend = True or False to show legend of this line on plot</span>
        <span class="c1"># addmarker = True or False to add markers</span>
        <span class="c1"># gradcolor = Create a graduated color scheme for the lines</span>
        <span class="c1">#</span>
        <span class="c1"># Also see http://nbviewer.ipython.org/gist/nipunreddevil/7734529 for converting dataframe to traces</span>
        <span class="c1"># Also see http://moderndata.plot.ly/color-scales-in-ipython-notebook/</span>

        <span class="n">x</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>

        <span class="n">traces</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># will be used for market opacity for the markers</span>
        <span class="n">increments</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">gradcolor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">colorlover</span> <span class="kn">as</span> <span class="nn">cl</span>
                <span class="n">color_def</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">scales</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">))][</span><span class="s1">&#39;seq&#39;</span><span class="p">][</span><span class="n">gradcolor</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Check colorlover installation...&#39;</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="p">:</span>
            <span class="n">scatter</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span>
                        <span class="n">y</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span>
                        <span class="n">xaxis</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">axis_no</span><span class="p">),</span>
                        <span class="n">yaxis</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">axis_no</span><span class="p">),</span>
                        <span class="n">showlegend</span> <span class="o">=</span> <span class="n">showlegend</span><span class="p">)</span>

            <span class="c1"># only apply color/marker properties if not &quot;default&quot;</span>
            <span class="k">if</span> <span class="n">color_def</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_def</span><span class="p">)]</span> <span class="o">!=</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">special_line</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
                    <span class="c1"># special case for lines labelled &quot;mean&quot;</span>
                    <span class="c1"># make line thicker</span>
                    <span class="n">scatter</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lines&#39;</span>
                    <span class="n">scatter</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span>
                                <span class="n">color</span> <span class="o">=</span> <span class="n">color_def</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_def</span><span class="p">)],</span>
                                <span class="n">width</span> <span class="o">=</span> <span class="mi">2</span>
                            <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">line_width</span> <span class="o">=</span> <span class="mi">1</span>

                    <span class="c1"># set properties for the markers which change opacity</span>
                    <span class="c1"># for markers make lines thinner</span>
                    <span class="k">if</span> <span class="n">addmarker</span><span class="p">:</span>
                        <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.05</span> <span class="o">+</span> <span class="p">(</span><span class="n">increments</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                        <span class="n">scatter</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;markers+lines&#39;</span>
                        <span class="n">scatter</span><span class="p">[</span><span class="s1">&#39;marker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span>
                                    <span class="n">color</span><span class="o">=</span><span class="n">color_def</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_def</span><span class="p">)],</span>  <span class="c1"># marker color</span>
                                    <span class="n">opacity</span> <span class="o">=</span> <span class="n">opacity</span><span class="p">,</span>
                                    <span class="n">size</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
                        <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.2</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">scatter</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;lines&#39;</span>

                    <span class="n">scatter</span><span class="p">[</span><span class="s1">&#39;line&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">Line</span><span class="p">(</span>
                            <span class="n">color</span> <span class="o">=</span> <span class="n">color_def</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">color_def</span><span class="p">)],</span>
                            <span class="n">width</span> <span class="o">=</span> <span class="n">line_width</span><span class="p">)</span>

                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scatter</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">traces</span>

    <span class="n">EventPlot</span><span class="o">.</span><span class="n">convert_df_plotly</span> <span class="o">=</span> <span class="n">convert_df_plotly</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="UK-election-analysis">UK election analysis<a class="anchor-link" href="#UK-election-analysis">&#182;</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We've now created several generic functions for downloading data, doing an event study and also for helping us out with plotting via Plotly. We now start work on the ukelection.py script, for pulling it all together. As a very first step we need to provide credentials for Plotly (you can get your own Plotly key and username <a href="https://plot.ly/python/getting-started/">here</a>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="c1"># for time series/maths</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="c1"># for plotting data</span>
<span class="kn">import</span> <span class="nn">plotly</span>
<span class="kn">import</span> <span class="nn">plotly.plotly</span> <span class="kn">as</span> <span class="nn">py</span>
<span class="kn">from</span> <span class="nn">plotly.graph_objs</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">ukelection</span><span class="p">():</span>
    <span class="c1"># Learn about API authentication here: https://plot.ly/python/getting-started</span>
    <span class="c1"># Find your api_key here: https://plot.ly/settings/api</span>
    <span class="n">plotly_username</span> <span class="o">=</span> <span class="s2">&quot;thalesians&quot;</span>
    <span class="n">plotly_api_key</span> <span class="o">=</span> <span class="s2">&quot;XXXXXXXXX&quot;</span>

    <span class="n">plotly</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">set_credentials_file</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">plotly_username</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="n">plotly_api_key</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's download our market data that we need (GBP/USD spot data) using the DataDownloader class. As a default, I've opted to use Bloomberg data. You can try other currency pairs or markets (for example FTSE), to compare results for the event study. Note that obviously each data vendor will have a different ticker in their system for what could well be the same asset. With FX, care must be taken to know which close the vendor is snapping. As a default we have opted for BGN, which for GBP/USD is the NY close value.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="n">ticker</span> <span class="o">=</span> <span class="s1">&#39;GBPUSD&#39;</span> <span class="c1"># will use in plot titles later (and for creating Plotly URL)</span>

    <span class="c1">##### download market GBP/USD data from Quandl, Bloomberg or CSV file</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;Bloomberg&quot;</span>
    <span class="c1"># source  = &quot;Quandl&quot;</span>
    <span class="c1"># source = &quot;CSV&quot;</span>

    <span class="n">csv_file</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">event_plot</span> <span class="o">=</span> <span class="n">EventPlot</span><span class="p">()</span>

    <span class="n">data_downloader</span> <span class="o">=</span> <span class="n">DataDownloader</span><span class="p">()</span>
    <span class="n">start_date</span> <span class="o">=</span> <span class="n">event_plot</span><span class="o">.</span><span class="n">parse_dates</span><span class="p">([</span><span class="s1">&#39;01/01/1975&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;Quandl&#39;</span><span class="p">:</span>
        <span class="n">vendor_ticker</span> <span class="o">=</span> <span class="s2">&quot;BOE/XUDLUSS&quot;</span>
    <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;Bloomberg&#39;</span><span class="p">:</span>
        <span class="n">vendor_ticker</span> <span class="o">=</span> <span class="s1">&#39;GBPUSD BGN Curncy&#39;</span>
    <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;CSV&#39;</span><span class="p">:</span>
        <span class="n">vendor_ticker</span> <span class="o">=</span> <span class="s1">&#39;GBPUSD&#39;</span>
        <span class="n">csv_file</span> <span class="o">=</span> <span class="s1">&#39;D:/GBPUSD.csv&#39;</span>

    <span class="n">spot</span> <span class="o">=</span> <span class="n">data_downloader</span><span class="o">.</span><span class="n">download_time_series</span><span class="p">(</span><span class="n">vendor_ticker</span><span class="p">,</span> <span class="n">ticker</span><span class="p">,</span> <span class="n">start_date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">source</span><span class="p">,</span> <span class="n">csv_file</span> <span class="o">=</span> <span class="n">csv_file</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The most important part of the study is getting the historical UK election dates! We can obtain these from Wikipedia. We then convert into Python format. We need to make sure we filter the UK election dates, for where we have spot data available.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="n">labour_wins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;28/02/1974&#39;</span><span class="p">,</span> <span class="s1">&#39;10/10/1974&#39;</span><span class="p">,</span> <span class="s1">&#39;01/05/1997&#39;</span><span class="p">,</span> <span class="s1">&#39;07/06/2001&#39;</span><span class="p">,</span> <span class="s1">&#39;05/05/2005&#39;</span><span class="p">]</span>
    <span class="n">conservative_wins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;03/05/1979&#39;</span><span class="p">,</span> <span class="s1">&#39;09/06/1983&#39;</span><span class="p">,</span> <span class="s1">&#39;11/06/1987&#39;</span><span class="p">,</span> <span class="s1">&#39;09/04/1992&#39;</span><span class="p">,</span> <span class="s1">&#39;06/05/2010&#39;</span><span class="p">]</span>

    <span class="c1"># convert to more easily readable format</span>
    <span class="n">labour_wins_d</span> <span class="o">=</span> <span class="n">event_plot</span><span class="o">.</span><span class="n">parse_dates</span><span class="p">(</span><span class="n">labour_wins</span><span class="p">)</span>
    <span class="n">conservative_wins_d</span> <span class="o">=</span> <span class="n">event_plot</span><span class="o">.</span><span class="n">parse_dates</span><span class="p">(</span><span class="n">conservative_wins</span><span class="p">)</span>

    <span class="c1"># only takes those elections where we have data</span>
    <span class="n">labour_wins_d</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">labour_wins_d</span> <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">spot</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()]</span>
    <span class="n">conservative_wins_d</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">conservative_wins_d</span> <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">spot</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()]</span>

    <span class="n">spot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Date&#39;</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We then call our event study function in EventPlot on our spot data, which compromises of the 20 days before up till the 20 days after the UK general election. We shall plot these lines later.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="c1"># number of days before and after for our event study</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span>
    <span class="n">post</span> <span class="o">=</span> <span class="mi">20</span>

    <span class="c1"># calculate spot path during Labour wins</span>
    <span class="n">labour_wins_spot</span> <span class="o">=</span> <span class="n">event_plot</span><span class="o">.</span><span class="n">event_study</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">labour_wins_d</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">mean_label</span> <span class="o">=</span> <span class="s1">&#39;Labour Mean&#39;</span><span class="p">)</span>

    <span class="c1"># calculate spot path during Conservative wins</span>
    <span class="n">conservative_wins_spot</span> <span class="o">=</span> <span class="n">event_plot</span><span class="o">.</span><span class="n">event_study</span><span class="p">(</span><span class="n">spot</span><span class="p">,</span> <span class="n">conservative_wins_d</span><span class="p">,</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">mean_label</span> <span class="o">=</span> <span class="s1">&#39;Conservative Mean&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Define our xaxis and yaxis labels, as well as our source, which we shall later include in the title.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="c1">##### Create separate plots of price action during Labour and Conservative wins</span>
    <span class="n">xaxis</span> <span class="o">=</span> <span class="s1">&#39;Days&#39;</span>
    <span class="n">yaxis</span> <span class="o">=</span> <span class="s1">&#39;Index&#39;</span>
    <span class="n">source_label</span> <span class="o">=</span> <span class="s2">&quot;Source: @thalesians/BBG/Wikipedia&quot;</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We're finally ready for our first plot! We shall plot GBP/USD moves over Labour election wins, using the default palette and then we shall embed it into the sheet, using the URL given to us from the Plotly website.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="c1">###### Plot market reaction during Labour UK election wins</span>
    <span class="c1">###### Using default color scheme</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39; during UK gen elect - Lab wins&#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;BR&gt;&#39;</span> <span class="o">+</span> <span class="n">source_label</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">event_plot</span><span class="o">.</span><span class="n">convert_df_plotly</span><span class="p">(</span><span class="n">labour_wins_spot</span><span class="p">),</span>
                 <span class="n">layout</span><span class="o">=</span><span class="n">event_plot</span><span class="o">.</span><span class="n">create_layout</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">py</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;labour-wins-&#39;</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[11]:</div>


<div class="output_html rendered_html output_subarea output_execute_result">
<iframe id="igraph" scrolling="no" style="border:none;"seamless="seamless" src="https://plot.ly/~thalesians/244.embed" height="525" width="100%"></iframe>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The "iplot" function will send it to Plotly's server (provided we have all the dependencies installed).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Alternatively, we could embed the HTML as an image, which we have taken from the Plotly website. Note this approach will yield a static image which is fetched from Plotly's servers. It also possible to write the image to disk. Later we shall show the embed function.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div>
    <a href="https://plot.ly/~thalesians/244/" target="_blank" title="GBPUSD during UK gen elect - Lab wins&lt;br&gt;Source: @thalesians/BBG/Wikipedia" style="display: block; text-align: center;"><img src="https://plot.ly/~thalesians/244.png" alt="GBPUSD during UK gen elect - Lab wins&lt;br&gt;Source: @thalesians/BBG/Wikipedia" style="max-width: 100%;"  onerror="this.onerror=null;this.src='https://plot.ly/404.png';" /></a>
    <script data-plotly="thalesians:244" src="https://plot.ly/embed.js" async></script>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We next plot GBP/USD over Conservative wins. In this instance, however, we have a graduated 'Blues' color scheme, given obviously that blue is the color of the Conserative party in the UK!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="c1">###### Plot market reaction during Conservative UK election wins</span>
    <span class="c1">###### Using varying shades of blue for each line (helped by colorlover library)</span>

    <span class="n">title</span> <span class="o">=</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39; during UK gen elect - Con wins &#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;BR&gt;&#39;</span> <span class="o">+</span> <span class="n">source_label</span>

    <span class="c1"># also apply graduated color scheme of blues (from light to dark)</span>
    <span class="c1"># see http://moderndata.plot.ly/color-scales-in-ipython-notebook/ for details on colorlover package</span>
    <span class="c1"># which allows you to set scales</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">event_plot</span><span class="o">.</span><span class="n">convert_df_plotly</span><span class="p">(</span><span class="n">conservative_wins_spot</span><span class="p">,</span> <span class="n">gradcolor</span><span class="o">=</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="n">addmarker</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
                 <span class="n">layout</span><span class="o">=</span><span class="n">event_plot</span><span class="o">.</span><span class="n">create_layout</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">xaxis</span><span class="p">,</span> <span class="n">yaxis</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">plot_url</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;conservative-wins-&#39;</span> <span class="o">+</span> <span class="n">ticker</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Embed the chart into the document using "embed". This essentially embeds the JavaScript code, necessary to make it interactive.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.tools</span> <span class="kn">as</span> <span class="nn">tls</span>

<span class="n">tls</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="s2">&quot;https://plot.ly/~thalesians/245&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[13]:</div>


<div class="output_html rendered_html output_subarea output_execute_result">
<iframe id="igraph" scrolling="no" style="border:none;"seamless="seamless" src="https://plot.ly/~thalesians/245.embed" height="525" width="100%"></iframe>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Our final plot, will consist of three subplots, Labour wins, Conservative wins, and average moves for both. We also add a grid and a grey background for each plot.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span>    <span class="c1">##### Plot market reaction during Conservative UK election wins</span>
    <span class="c1">##### create a plot consisting of 3 subplots (from left to right)</span>
    <span class="c1">##### 1. Labour wins, 2. Conservative wins, 3. Conservative/Labour mean move</span>

    <span class="c1"># create a dataframe which grabs the mean from the respective Lab &amp; Con election wins</span>
    <span class="n">mean_wins_spot</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">mean_wins_spot</span><span class="p">[</span><span class="s1">&#39;Labour Mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labour_wins_spot</span><span class="p">[</span><span class="s1">&#39;Labour Mean&#39;</span><span class="p">]</span>
    <span class="n">mean_wins_spot</span><span class="p">[</span><span class="s1">&#39;Conservative Mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conservative_wins_spot</span><span class="p">[</span><span class="s1">&#39;Conservative Mean&#39;</span><span class="p">]</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">tools</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1"># apply different color scheme (red = Lab, blue = Con)</span>
    <span class="c1"># also add markets, which will have varying levels of opacity</span>
    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Data</span><span class="p">(</span>
        <span class="n">event_plot</span><span class="o">.</span><span class="n">convert_df_plotly</span><span class="p">(</span><span class="n">conservative_wins_spot</span><span class="p">,</span> <span class="n">axis_no</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">color_def</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">],</span> <span class="n">addmarker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">event_plot</span><span class="o">.</span><span class="n">convert_df_plotly</span><span class="p">(</span><span class="n">labour_wins_spot</span><span class="p">,</span> <span class="n">axis_no</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                     <span class="n">color_def</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">],</span> <span class="n">addmarker</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">+</span>
        <span class="n">event_plot</span><span class="o">.</span><span class="n">convert_df_plotly</span><span class="p">(</span><span class="n">mean_wins_spot</span><span class="p">,</span> <span class="n">axis_no</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                     <span class="n">color_def</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">],</span> <span class="n">addmarker</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">showlegend</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span>
                        <span class="p">)</span>

    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39; during UK gen elects by winning party &#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;BR&gt;&#39;</span> <span class="o">+</span> <span class="n">source_label</span><span class="p">)</span>

    <span class="c1"># use the scheme from https://plot.ly/python/bubble-charts-tutorial/</span>
    <span class="c1"># can use dict approach, rather than specifying each separately</span>
    <span class="n">axis_style</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">gridcolor</span><span class="o">=</span><span class="s1">&#39;#FFFFFF&#39;</span><span class="p">,</span>  <span class="c1"># white grid lines</span>
            <span class="n">ticks</span><span class="o">=</span><span class="s1">&#39;outside&#39;</span><span class="p">,</span>      <span class="c1"># draw ticks outside axes</span>
            <span class="n">ticklen</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>            <span class="c1"># tick length</span>
            <span class="n">tickwidth</span><span class="o">=</span><span class="mf">1.5</span>         <span class="c1">#   and width</span>
        <span class="p">)</span>

    <span class="c1"># create the various axes for the three separate charts</span>
    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xaxis1</span><span class="o">=</span><span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">XAxis</span><span class="p">(</span><span class="n">axis_style</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">xaxis</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">yaxis1</span><span class="o">=</span><span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">YAxis</span><span class="p">(</span><span class="n">axis_style</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">yaxis</span><span class="p">))</span>

    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xaxis2</span><span class="o">=</span><span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">XAxis</span><span class="p">(</span><span class="n">axis_style</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">xaxis</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">yaxis2</span><span class="o">=</span><span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">YAxis</span><span class="p">(</span><span class="n">axis_style</span><span class="p">))</span>

    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xaxis3</span><span class="o">=</span><span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">XAxis</span><span class="p">(</span><span class="n">axis_style</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">xaxis</span><span class="p">))</span>
    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">yaxis3</span><span class="o">=</span><span class="n">plotly</span><span class="o">.</span><span class="n">graph_objs</span><span class="o">.</span><span class="n">YAxis</span><span class="p">(</span><span class="n">axis_style</span><span class="p">))</span>

    <span class="n">fig</span><span class="p">[</span><span class="s1">&#39;layout&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;#EFECEA&#39;</span><span class="p">)</span>  <span class="c1"># set plot background to grey</span>

    <span class="n">plot_url</span> <span class="o">=</span> <span class="n">py</span><span class="o">.</span><span class="n">iplot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;labour-conservative-wins-&#39;</span><span class="o">+</span> <span class="n">ticker</span> <span class="o">+</span> <span class="s1">&#39;-subplot&#39;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

<div class="output_subarea output_stream output_stdout output_text">
<pre>This is the format of your plot grid:
[ (1,1) x1,y1 ]  [ (1,2) x2,y2 ]  [ (1,3) x3,y3 ]

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This time we use "embed", which grab the plot from Plotly's server, we did earlier (given we have already uploaded it).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span></span><span class="kn">import</span> <span class="nn">plotly.tools</span> <span class="kn">as</span> <span class="nn">tls</span>

<span class="n">tls</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="s2">&quot;https://plot.ly/~thalesians/246&quot;</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt output_prompt">Out[15]:</div>


<div class="output_html rendered_html output_subarea output_execute_result">
<iframe id="igraph" scrolling="no" style="border:none;"seamless="seamless" src="https://plot.ly/~thalesians/246.embed" height="525" width="100%"></iframe>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><B>That's about it!</B> I hope the code I've written proves fruitful for creating some very cool Plotly plots and also for doing some very timely analysis ahead of the UK general election! Hoping this will be first of many blogs on using Plotly data.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The analysis in this blog is based on a report I wrote for Thalesians, a quant finance thinktank. If you are interested in getting access to the full copy of the report (Thalesians: My kingdom for a vote - The definitive quant guide to UK general elections), feel free to e-mail me at <b>saeed@thalesians.com</b> or tweet me &lt;b&gt;@thalesians&lt;/b&gt;</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Want-to-hear-more-about-global-macro-and-UK-election-developments?">Want to hear more about global macro and UK election developments?<a class="anchor-link" href="#Want-to-hear-more-about-global-macro-and-UK-election-developments?">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If you're interested in FX and the UK general election, come to our Thalesians panel in London on April 29th 2015 at 7.30pm in Canary Wharf, which will feature, Eric Burroughs (Reuters - FX Buzz Editor), Mark Cudmore (Bloomberg - First Word EM Strategist), Jordan Rochester (Nomura - FX strategist), Jeremy Wilkinson-Smith (Independent FX trader) and myself as the moderator. Tickets are available <a href="http://www.meetup.com/thalesians/events/221147156/">here</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Biography">Biography<a class="anchor-link" href="#Biography">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><b>Saeed Amen</b> is the managing director and co-founder of the Thalesians. He has a decade of experience creating and successfully running systematic trading models at Lehman Brothers, Nomura and now at the Thalesians. Independently, he runs a systematic trading model with proprietary capital. He is the author of Trading Thalesians  What the ancient world can teach us about trading today (Palgrave Macmillan). He graduated with a first class honours masters degree from Imperial College in Mathematics &amp; Computer Science. He is also a fan of Python and has written an extensive library for financial market backtesting called PyThalesians.</p>
<BR>

<p>Follow the Thalesians on Twitter @thalesians and get my book on Amazon <a href="http://www.amazon.co.uk/Trading-Thalesians-Saeed-Amen/dp/113739952X">here</a></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>All the code here is available to download from the <a href="https://github.com/thalesians/pythalesians">Thalesians GitHub page</a></p>

</div>
</div>
</div>


{% endraw %}
